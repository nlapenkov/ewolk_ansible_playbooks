
- name: Install & configure need soft & users
  apt: pkg={{ item }} state=latest
  with_items:
    - sudo
    - mailutils
    - libsasl2-modules
    - mc
    - htop
    - net-tools
    - logtail
    - curl
    - wget


- name: Ensure group "admins" exists
  group:
    name: admins
    state: present


- name: Create new user "nlapenkov"
  user:
    name: nlapenkov
    password: "{{ user_password }}"
    groups: admins
    state: present
    shell: /bin/bash
    system: no
    createhome: yes
    home: /home/nlapenkov
- name: Force change password for "nlapenkov"
  shell: chage -d 0 nlapenkov


- name: Create new user "akolesnik"
  user:
    name: akolesnik
    password: "{{ user_password }}"
    groups: admins
    state: present
    shell: /bin/bash
    system: no
    createhome: yes
    home: /home/akolesnik
- name: Force change password for "akolesnik"
  shell: chage -d 0 akolesnik


- name: Create new user "rfedorets"
  user:
    name: rfedorets
    password: "{{ user_password }}"
    groups: admins
    state: present
    shell: /bin/bash
    system: no
    createhome: yes
    home: /home/rfedorets
- name: Force change password for "rfedorets"
  shell: chage -d 0 rfedorec
    

- name: Add group "admins" to SUDO
  lineinfile:
    dest: /etc/sudoers
    line: '%admins ALL=(ALL:ALL) ALL'


- name: Relay postfix google
  lineinfile: 
    dest=/etc/postfix/main.cf
    regexp='^relayhost ='
    state=absent
- name: add a multiline string to the file and delete the string from before
  lineinfile: 
    dest: /etc/postfix/main.cf
    line: '{{ item }}'
  with_items:
    - 'virtual_alias_maps = hash:/etc/postfix/virtual'
    - '# Relaying Postfix SMTP via GMAIL'
    - 'smtp_sasl_auth_enable = yes'
    - 'smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd'
    - 'smtp_sasl_security_options = noanonymous'
    - 'smtp_tls_CAfile = /etc/postfix/cacert.pem'
    - 'smtp_use_tls = yes' 
- name: Change relayhost 
  lineinfile: 
    dest: /etc/postfix/main.cf
    insertbefore: '^smtp_sasl_auth_enable = yes'
    line: 'relayhost = [smtp.gmail.com]:587'


- name: Create /etc/postfix/sasl_passwd
  template:
    src: sasl_passwd 
    dest: /etc/postfix/sasl_passwd
- name: Set permission /etc/postfix/sasl_passwd
  file:
    path: /etc/postfix/sasl_passwd
    mode: 0400
- name: Postmap /etc/postfix/sasl_passwd
  command: postmap /etc/postfix/sasl_passwd


- name: Create /etc/postfix/virtual
  template:
    src: virtual
    dest: /etc/postfix/virtual
- name: Set permission /etc/postfix/virtual
  file:
    path: /etc/postfix/virtual
    mode: 0400
- name: Postmap /etc/postfix/virtual
  command: postmap /etc/postfix/virtual


- name: Create /etc/ssl/certs/Thawte_Premium_Server_CA.pem
  template:
    src: Thawte_Premium_Server_CA.pem
    dest: /etc/ssl/certs/Thawte_Premium_Server_CA.pem
- name: Change /etc/postfix/cacert.pem
  shell: 'cat /etc/ssl/certs/Thawte_Premium_Server_CA.pem | tee -a /etc/postfix/cacert.pem'
  notify:
    - service postfix restart


- name: Test email
  shell: 'echo "Hello World" | mail -s "Test Message" sup@ewolk.net'


- name: Configure IPTABLES rules
  template:
    src: iptables.j2
    dest: /etc/network/if-pre-up.d/iptables
- name: Set permissions 777 to IPTABLES script
  file:
    path: /etc/network/if-pre-up.d/iptables
    mode: 0777


- name: Add vmbr2 network-interfaces
  lineinfile:
    dest: /etc/network/interfaces
    line: '{{ item }}'
  with_items:
    - 'auto vmbr2'
    - 'iface vmbr2 inet static'
    - 'address  192.168.10.1'
    - 'netmask  255.255.255.0'
    - 'bridge_ports none'
    - 'bridge_stp off'
    - 'bridge_fd 0'